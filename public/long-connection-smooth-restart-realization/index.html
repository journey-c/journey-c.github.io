<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.74.3" />


<title>长连接平滑重启 - Journey-C</title>
<meta property="og:title" content="长连接平滑重启 - Journey-C">


<link href='https://journey-c.github.io/favicon.png' rel='icon' type='image/x-icon' />








<link rel="icon" href="https://journey-c.github.io/images/" type="image/x-icon" />
<link rel="stylesheet" href="https://journey-c.github.io/css/main.css" media="all">
<link rel="stylesheet" href="https://journey-c.github.io/css/fonts.css" media="all">
<link rel="stylesheet" href="https://journey-c.github.io/css/prism.css" media="all">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700">
<script type="text/javascript" src="https://journey-c.github.io/js/main.js"></script>
<script type="text/javascript" src="https://journey-c.github.io/js/prism.js"></script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-181048644-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



<script async src="https://www.googletagmanager.com/gtag/js?id=UA-181048644-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-181048644-1');
</script>



</head>

<body>
    <input type="checkbox" class="hidden toggle" id="toc-control" />
    <main class="wrapper">
        <div>
            <header class="header">
                <nav class="nav">
    <a href="https://journey-c.github.io/" class="nav-logo">
        <img src="https://journey-c.github.io/images/yangguo.png" width="50"
            height="50" alt="Logo">
    </a>

    <ul class="nav-links">
        
        <li><a href="/tags/"></a></li>
        
        <li><a href="/about/">About</a></li>
        
        <li><a href="https://github.com/journey-c">Github</a></li>
        
        <li><a href="https://www.cnblogs.com/wuwangchuxin0924/">博客园</a></li>
        
        <li>
    </ul>
</nav>

            </header>
        </div>

        <div>
            <header class="mobile-header">
                <a href="https://journey-c.github.io/" class="nav-logo">
                    <img src="https://journey-c.github.io/images/yangguo.png"
                        width="50" height="50"
                        alt="Logo">
                </a>

                <div style="float:right">
                    <label for="toc-control">
                        <img src="/svg/toc.svg" class="article-icon" alt="Table of Contents" />
                    </label>
                </div>

                <ul class="nav-links">
                    
                    <li><a href="/tags/"></a></li>
                    
                    <li><a href="/about/">About</a></li>
                    
                    <li><a href="https://github.com/journey-c">Github</a></li>
                    
                    <li><a href="https://www.cnblogs.com/wuwangchuxin0924/">博客园</a></li>
                    
                    <li>
                </ul>

                <aside class="hidden clearfix mobile-toc">
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#1难点">1.难点</a></li>
    <li><a href="#2解决">2.解决</a>
      <ul>
        <li><a href="#21-如何做到不中断接受连接">2.1 如何做到不中断接受连接</a></li>
        <li><a href="#22-如何做到已有连接不中断">2.2 如何做到已有连接不中断</a></li>
      </ul>
    </li>
    <li><a href="#3-demo实现">3. Demo实现</a></li>
  </ul>
</nav>
                </aside>
            </header>
        </div>


<div class="content">
    
    <aside class="article-toc" id="article-toc">
    <div class="article-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#1难点">1.难点</a></li>
    <li><a href="#2解决">2.解决</a>
      <ul>
        <li><a href="#21-如何做到不中断接受连接">2.1 如何做到不中断接受连接</a></li>
        <li><a href="#22-如何做到已有连接不中断">2.2 如何做到已有连接不中断</a></li>
      </ul>
    </li>
    <li><a href="#3-demo实现">3. Demo实现</a></li>
  </ul>
</nav>
    </div>
</aside>

    

    <article class="article">
        
        <span class="article-duration">5 min read</span>
        

        <h1 class="article-title">长连接平滑重启</h1>

        
        <span class="article-date">2020-10-21</span>
        

        
        
        
        <a class="article-tag" href="https://journey-c.github.io/%20tags/%E7%BD%91%E7%BB%9C">网络</a>
        
        <a class="article-tag" href="https://journey-c.github.io/%20tags/golang">Golang</a>
        
        
        

        <div class="article-content">
            <blockquote>
<p>最近小编一直在做长连接相关的事情，最大的感触就是发版太痛苦，一个个踢掉连接然后发版，导致发版时长过长，操作繁琐。所以在想能不能实现优雅重启, 发版时客户端无感知。</p>
</blockquote>
<h1 id="1难点">1.难点</h1>
<ul>
<li>
<p>如何做到不中断接收连接</p>
</li>
<li>
<p>如何做到已有连接不中断</p>
</li>
</ul>
<h1 id="2解决">2.解决</h1>
<h2 id="21-如何做到不中断接受连接">2.1 如何做到不中断接受连接</h2>
<p>以下是linux源码中bind的实现(linux-1.0)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// linux-1.0/net/socket.c 536
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span>
<span style="color:#a6e22e">sock_bind</span>(<span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>umyaddr, <span style="color:#66d9ef">int</span> addrlen)
{
  <span style="color:#66d9ef">struct</span> socket <span style="color:#f92672">*</span>sock;
  <span style="color:#66d9ef">int</span> i;

  DPRINTF((net_debug, <span style="color:#e6db74">&#34;NET: sock_bind: fd = %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, fd));
  <span style="color:#66d9ef">if</span> (fd <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> fd <span style="color:#f92672">&gt;=</span> NR_OPEN <span style="color:#f92672">||</span> current<span style="color:#f92672">-&gt;</span>filp[fd] <span style="color:#f92672">==</span> NULL)
								<span style="color:#66d9ef">return</span>(<span style="color:#f92672">-</span>EBADF);
  <span style="color:#75715e">//获取fd对应的socket结构
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(sock <span style="color:#f92672">=</span> sockfd_lookup(fd, NULL))) <span style="color:#66d9ef">return</span>(<span style="color:#f92672">-</span>ENOTSOCK);
  <span style="color:#75715e">// 转调用bind指向的函数，下层函数(inet_bind)
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> ((i <span style="color:#f92672">=</span> sock<span style="color:#f92672">-&gt;</span>ops<span style="color:#f92672">-&gt;</span>bind(sock, umyaddr, addrlen)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
	DPRINTF((net_debug, <span style="color:#e6db74">&#34;NET: sock_bind: bind failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>));
	<span style="color:#66d9ef">return</span>(i);
  }
  <span style="color:#66d9ef">return</span>(<span style="color:#ae81ff">0</span>);
}

<span style="color:#75715e">// linux-1.0/net/inet/sock.c 1012
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span>
<span style="color:#a6e22e">inet_bind</span>(<span style="color:#66d9ef">struct</span> socket <span style="color:#f92672">*</span>sock, <span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>uaddr,
	       <span style="color:#66d9ef">int</span> addr_len)
{
  ...
outside_loop:
  <span style="color:#66d9ef">for</span>(sk2 <span style="color:#f92672">=</span> sk<span style="color:#f92672">-&gt;</span>prot<span style="color:#f92672">-&gt;</span>sock_array[snum <span style="color:#f92672">&amp;</span> (SOCK_ARRAY_SIZE <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)];
					sk2 <span style="color:#f92672">!=</span> NULL; sk2 <span style="color:#f92672">=</span> sk2<span style="color:#f92672">-&gt;</span>next) {
<span style="color:#75715e">#if 	1	</span><span style="color:#75715e">/* should be below! */</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (sk2<span style="color:#f92672">-&gt;</span>num <span style="color:#f92672">!=</span> snum) <span style="color:#66d9ef">continue</span>;
<span style="color:#75715e">/*	if (sk2-&gt;saddr != sk-&gt;saddr) continue; */</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (sk2<span style="color:#f92672">-&gt;</span>dead) {
		destroy_sock(sk2);
		<span style="color:#66d9ef">goto</span> outside_loop;
	}
	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>sk<span style="color:#f92672">-&gt;</span>reuse) {
		sti();
		<span style="color:#66d9ef">return</span>(<span style="color:#f92672">-</span>EADDRINUSE);
	}
	<span style="color:#66d9ef">if</span> (sk2<span style="color:#f92672">-&gt;</span>num <span style="color:#f92672">!=</span> snum) <span style="color:#66d9ef">continue</span>;		<span style="color:#75715e">/* more than one */</span>
	<span style="color:#66d9ef">if</span> (sk2<span style="color:#f92672">-&gt;</span>saddr <span style="color:#f92672">!=</span> sk<span style="color:#f92672">-&gt;</span>saddr) <span style="color:#66d9ef">continue</span>;	<span style="color:#75715e">/* socket per slot ! -FB */</span>
	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>sk2<span style="color:#f92672">-&gt;</span>reuse) {
		sti();
		<span style="color:#66d9ef">return</span>(<span style="color:#f92672">-</span>EADDRINUSE);
	}
  }
  ... 
}

</code></pre></div><ul>
<li>sock_array是一个链式哈希表，保存着各端口号的sock结构</li>
<li>通过源码可以看到，bind的时候会检测要绑定的地址和端口是否合法以及已被绑定, 如果发版时另一个进程和旧进程没有关系，则bind会返回错误Address already in use</li>
<li>若旧进程fork出新进程，新进程和旧进程为父子关系，新进程继承旧进程的文件表，本身&quot;本进程&quot;就已经监听这个端口了，则不会出现上面的问题</li>
</ul>
<h2 id="22-如何做到已有连接不中断">2.2 如何做到已有连接不中断</h2>
<ul>
<li>
<p>新进程继承旧进程的用于连接的fd，并且继续维持与客户端的心跳</p>
<p>linux提供了unix域套接字可用于socket的传输, 新进程起来后通过unix socket通信继承旧进程所维护的连接</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
ssize_t <span style="color:#a6e22e">sendmsg</span>(<span style="color:#66d9ef">int</span> sockfd, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> msghdr <span style="color:#f92672">*</span>msg, <span style="color:#66d9ef">int</span> flags);
ssize_t <span style="color:#a6e22e">recvmsg</span>(<span style="color:#66d9ef">int</span> sockfd, <span style="color:#66d9ef">struct</span> msghdr <span style="color:#f92672">*</span>msg, <span style="color:#66d9ef">int</span> flags);
</code></pre></div><p>发送端调用sendmsg发送文件描述符，接收端调用revmsg接收文件描述符。</p>
<p>两进程共享同一打开文件表，这与fork之后的父子进程共享打开文件表的情况完全相同。</p>
<p><em><strong>由此解决了文章开头提出的两个问题</strong></em></p>
<h1 id="3-demo实现">3. Demo实现</h1>
<ul>
<li>
<p>进程每次启动时必须check有无继承socket(尝试连接本地的unix server，如果连接失败，说明是第一次启动，否则可能有继承的socket)，如果有，就将socket加入到自己的连接池中, 并初始化连接状态</p>
</li>
<li>
<p>旧进程监听USR2信号(通知进程需要重启，使用信号、http接口等都可)，监听后动作:</p>
<ol>
<li>监听Unix socket, 等待新进程初始化完成，发来开始继承连接的请求</li>
<li>使用旧进程启动的命令fork一个子进程(发布到线上的新二进制)。</li>
<li>accept到新进程的请求，关闭旧进程listener(保证旧进程不会再接收新请求，同时所有connector不在进行I/O操作。</li>
<li>旧进程将现有连接的socket，以及连接状态(读写buffer，connect session)通过 unix socket发送到新进程。</li>
<li>最后旧进程给新进程发送发送完毕信号，随后退出</li>
</ol>
</li>
<li>
<p>以下是简单实现的demo, demo中实现较为简单，只实现了文件描述符的传递，没有实现各连接状态的传递。</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// server.go
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;flag&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;golang.org/x/sys/unix&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;os/signal&#34;</span>
	<span style="color:#e6db74">&#34;path/filepath&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;syscall&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">var</span> (
	<span style="color:#a6e22e">workSpace</span> <span style="color:#66d9ef">string</span>

	<span style="color:#a6e22e">logger</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>

	<span style="color:#a6e22e">writeTimeout</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>
	<span style="color:#a6e22e">readTimeout</span>  = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>

	<span style="color:#a6e22e">signalChan</span> = make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Signal</span>)

	<span style="color:#a6e22e">connFiles</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Map</span>

	<span style="color:#a6e22e">serverListener</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listener</span>

	<span style="color:#a6e22e">isUpdate</span> = <span style="color:#66d9ef">false</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">StringVar</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">workSpace</span>, <span style="color:#e6db74">&#34;w&#34;</span>, <span style="color:#e6db74">&#34;.&#34;</span>, <span style="color:#e6db74">&#34;Usage:\n ./server -w=workspace&#34;</span>)
	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()

	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">workSpace</span>, <span style="color:#e6db74">&#34;server.log&#34;</span>), <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_WRONLY</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_APPEND</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>, <span style="color:#ae81ff">0777</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">logger</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">file</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">11</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">beforeStart</span>()
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">signalHandler</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">serverListener</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;:7000&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isUpdate</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">serverListener</span>.<span style="color:#a6e22e">Accept</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;conn error&#34;</span>)
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>)
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">connectionHandler</span>(<span style="color:#a6e22e">c</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">connectionHandler</span>(<span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>) {
	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">File</span>()
	<span style="color:#a6e22e">connFiles</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#a6e22e">file</span>, <span style="color:#66d9ef">true</span>)
	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;conn fd %d\n&#34;</span>, <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Fd</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">connFiles</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">file</span>)
		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
	}()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isUpdate</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SetReadDeadline</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">readTimeout</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">rBuf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">4</span>)
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">rBuf</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#66d9ef">if</span> string(<span style="color:#a6e22e">rBuf</span>) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;ping&#34;</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;failed to parse the message &#34;</span> <span style="color:#f92672">+</span> string(<span style="color:#a6e22e">rBuf</span>))
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SetWriteDeadline</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">writeTimeout</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">`pong`</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">return</span>
		}
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">beforeStart</span>() {
	<span style="color:#a6e22e">connInterface</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;unix&#34;</span>, <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">workSpace</span>, <span style="color:#e6db74">&#34;conn.sock&#34;</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">connInterface</span>.<span style="color:#a6e22e">Close</span>()
	}()

	<span style="color:#a6e22e">unixConn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">connInterface</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">UnixConn</span>)

	<span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">1</span>)
	<span style="color:#a6e22e">oob</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">32</span>)
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">unixConn</span>.<span style="color:#a6e22e">SetWriteDeadline</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">oobn</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unixConn</span>.<span style="color:#a6e22e">ReadMsgUnix</span>(<span style="color:#a6e22e">b</span>, <span style="color:#a6e22e">oob</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
				<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;recv fd type error: %d\n&#34;</span>, <span style="color:#a6e22e">n</span>)
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;init finish&#34;</span>)
			}
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">scms</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">ParseSocketControlMessage</span>(<span style="color:#a6e22e">oob</span>[<span style="color:#ae81ff">0</span>:<span style="color:#a6e22e">oobn</span>])
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">scms</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;recv fd num != 1 : %d\n&#34;</span>, len(<span style="color:#a6e22e">scms</span>))
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">fds</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">ParseUnixRights</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">scms</span>[<span style="color:#ae81ff">0</span>])
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">fds</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;recv fd num != 1 : %d\n&#34;</span>, len(<span style="color:#a6e22e">fds</span>))
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;recv fd %d\n&#34;</span>, <span style="color:#a6e22e">fds</span>[<span style="color:#ae81ff">0</span>])
		<span style="color:#a6e22e">file</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">NewFile</span>(uintptr(<span style="color:#a6e22e">fds</span>[<span style="color:#ae81ff">0</span>]), <span style="color:#e6db74">&#34;fd-from-old&#34;</span>)
		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">FileConn</span>(<span style="color:#a6e22e">file</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">connectionHandler</span>(<span style="color:#a6e22e">conn</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>))
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">signalHandler</span>() {
	<span style="color:#a6e22e">signal</span>.<span style="color:#a6e22e">Notify</span>(
		<span style="color:#a6e22e">signalChan</span>,
		<span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGUSR2</span>,
	)
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">sc</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">signalChan</span>
		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">sc</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGUSR2</span>:
			<span style="color:#a6e22e">gracefulExit</span>()
		<span style="color:#66d9ef">default</span>:
			<span style="color:#66d9ef">continue</span>
		}
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">gracefulExit</span>() {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">connWait</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">Unlink</span>(<span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">workSpace</span>, <span style="color:#e6db74">&#34;conn.sock&#34;</span>))
	<span style="color:#a6e22e">listenerInterface</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;unix&#34;</span>, <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">workSpace</span>, <span style="color:#e6db74">&#34;conn.sock&#34;</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">listenerInterface</span>.<span style="color:#a6e22e">Close</span>()
	}()
	<span style="color:#a6e22e">unixListener</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listenerInterface</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">UnixListener</span>)
	<span style="color:#a6e22e">connWait</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">connWait</span>.<span style="color:#a6e22e">Done</span>()
		<span style="color:#a6e22e">unixConn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unixListener</span>.<span style="color:#a6e22e">AcceptUnix</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
			<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">unixConn</span>.<span style="color:#a6e22e">Close</span>()
		}()
		<span style="color:#a6e22e">connFiles</span>.<span style="color:#a6e22e">Range</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">bool</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
			}
			<span style="color:#a6e22e">file</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">key</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">File</span>)
			<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
				<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Close</span>()
			}()
			<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">1</span>)
			<span style="color:#a6e22e">buf</span>[<span style="color:#ae81ff">0</span>] = <span style="color:#ae81ff">0</span>
			<span style="color:#a6e22e">rights</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">UnixRights</span>(int(<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Fd</span>()))
			<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unixConn</span>.<span style="color:#a6e22e">WriteMsgUnix</span>(<span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">rights</span>, <span style="color:#66d9ef">nil</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			}
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;send fd %d\n&#34;</span>, <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Fd</span>())
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
		})
		<span style="color:#a6e22e">finish</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">1</span>)
		<span style="color:#a6e22e">finish</span>[<span style="color:#ae81ff">0</span>] = <span style="color:#ae81ff">1</span>
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">unixConn</span>.<span style="color:#a6e22e">WriteMsgUnix</span>(<span style="color:#a6e22e">finish</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
		}
	}()

	<span style="color:#a6e22e">isUpdate</span> = <span style="color:#66d9ef">true</span>
	<span style="color:#a6e22e">execSpec</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">ProcAttr</span>{
		<span style="color:#a6e22e">Env</span>:   <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Environ</span>(),
		<span style="color:#a6e22e">Files</span>: append([]<span style="color:#66d9ef">uintptr</span>{<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdin</span>.<span style="color:#a6e22e">Fd</span>(), <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdout</span>.<span style="color:#a6e22e">Fd</span>(), <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>.<span style="color:#a6e22e">Fd</span>()}),
	}

	<span style="color:#a6e22e">pid</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">ForkExec</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>, <span style="color:#a6e22e">execSpec</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;old process %d new process %d\n&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getpid</span>(), <span style="color:#a6e22e">pid</span>)
	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">serverListener</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#a6e22e">connWait</span>.<span style="color:#a6e22e">Wait</span>()
	<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">0</span>)
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// client.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">var</span> (
	<span style="color:#a6e22e">writeTimeout</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>
	<span style="color:#a6e22e">readTimeout</span>  = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1:7000&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
	}()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SetWriteDeadline</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">writeTimeout</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;send ping&#34;</span>)
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">`ping`</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SetReadDeadline</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">readTimeout</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#a6e22e">rBuf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">4</span>)
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">rBuf</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;recv &#34;</span> <span style="color:#f92672">+</span> string(<span style="color:#a6e22e">rBuf</span>))
	}
}
</code></pre></div>
        </div>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'a60f22cd3c5d7e6aafa8',
        clientSecret: 'db8f7c66f2e8e20275173155975b749870291c5b',
        repo: 'journey-c.github.io',
        owner: 'journey-c',
        admin: ['journey-c'],
        id: '长连接平滑重启',
        distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
</script>

        

        
    </article>
</div>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <p>Copyright @ 2020-<script>document.write(new Date().getFullYear())</script> <a class="footer-links-kudos" href="https://github.com/journey-c">Journey-C</a>.
    </p>
          </li>
        </ul>
      </footer>
    </main>

    <script type=text/javascript async src="https://cdn.staticfile.org/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$']],
            processEscapes: true,
            processEnvironments: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            TeX: {
                equationNumbers: {
                    autoNumber: "AMS"
                },
                extensions: ["AMSmath.js", "AMSsymbols.js"]
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(),
            i;
        for (i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
    MathJax.Hub.Config({
        TeX: {
            equationNumbers: {
                autoNumber: "AMS"
            }
        }
    });
    </script>
  </body>
</html>

